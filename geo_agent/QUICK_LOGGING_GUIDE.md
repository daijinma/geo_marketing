# geo_agent 日志功能快速指南

## 🎯 已完成！所有日志增强功能已上线

从终端输出可以看到，现在每个请求都会显示完整的处理流程：

## 📊 日志输出示例

```
🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵
🌐 HTTP请求 - POST /v1/chat/completions
🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵
Request ID: req_ea7081b82a954f6f
客户端IP: 127.0.0.1
完整URL: http://localhost:8100/v1/chat/completions
...

================================================================================
📨 收到OpenAI格式请求 - Request ID: req_a7c0d788a9304475
================================================================================
模型: qwen3-max
消息数: 1
流式: False
温度: 0.7
...

================================================================================
🚀 调用DashScope API
================================================================================
模型: qwen-max
流式: False
消息数: 1
参数: {...}
...

================================================================================
✅ DashScope API响应
================================================================================
响应内容: 你好！我是Qwen...
Token使用:
  输入tokens: 12
  输出tokens: 118
  总tokens: 130
耗时: 5312.05ms
...

================================================================================
✨ 返回OpenAI格式响应 - Request ID: req_a7c0d788a9304475
================================================================================
响应内容: ...
Token使用: ...
总耗时: 5313.04ms
...

🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢
✅ HTTP响应 - 200
🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢
状态码: 200
耗时: 5316.83ms
🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢
```

## 🚀 快速开始

### 1. 启动服务（查看详细日志）
```bash
cd geo_agent
make dev
```

### 2. 发送测试请求
```bash
# 在另一个终端
make test-curl
```

### 3. 查看日志
- **控制台输出**: 在运行 `make dev` 的终端查看实时详细日志
- **日志文件**: 查看 `logs/` 目录下的 JSON 格式日志文件

## 📋 日志包含的信息

每个请求都会追踪以下信息：

✅ **Request ID** - 唯一标识，用于链路追踪
✅ **客户端信息** - IP 地址、请求头
✅ **请求参数** - 模型、温度、最大 tokens、消息内容
✅ **API 调用** - DashScope 实际调用参数
✅ **响应内容** - 完整的响应文本
✅ **Token 使用** - 输入/输出/总计 tokens
✅ **性能指标** - 各阶段耗时
✅ **完成状态** - finish_reason、状态码

## 🎨 日志图标说明

- 🔵 蓝色边框 = HTTP 请求入口
- 📨 邮件图标 = OpenAI 格式请求
- 📤 发送箱 = 中转请求
- 🚀 火箭 = DashScope API 调用
- ✅ 绿色勾 = DashScope 响应成功
- 📥 接收箱 = 中转响应
- ✨ 星星 = OpenAI 格式响应
- 🟢 绿色边框 = HTTP 响应返回
- ❌ 红叉 = 错误

## 📁 日志文件

所有详细日志同时保存在：

- `logs/access.log` - HTTP 访问日志
- `logs/qwen_calls.log` - Qwen API 调用详细日志
- `logs/error.log` - 错误日志

查看日志文件：
```bash
# 实时查看 Qwen API 调用日志（JSON 格式化）
make logs-qwen

# 查看所有日志
make logs

# 查看统计信息
make stats
```

## 🔍 调试技巧

### 追踪特定请求
每个请求有唯一的 Request ID，在日志中搜索：
```bash
grep "req_ea7081b82a954f6f" logs/*.log
```

### 查看 Token 使用
```bash
# 总 Token 使用量
make stats

# 查看详细的 Token 使用
grep "total_tokens" logs/qwen_calls.log | jq '.usage.total_tokens'
```

### 分析性能
```bash
# 平均延迟
make stats

# 查看慢请求（> 5秒）
grep "latency_ms" logs/qwen_calls.log | jq 'select(.latency_ms > 5000)'
```

## ⚙️ 配置

### 调整日志级别
编辑 `.env` 文件：
```bash
# 开发环境 - 显示所有详细日志
LOG_LEVEL=INFO

# 生产环境 - 只显示警告和错误
LOG_LEVEL=WARNING
```

### 禁用控制台详细输出
如果只想保留日志文件记录，不需要控制台详细输出：
1. 设置 `LOG_LEVEL=WARNING`
2. 日志文件仍会记录所有详细信息

## 📚 相关文档

- [LOGGING_ENHANCEMENTS.md](LOGGING_ENHANCEMENTS.md) - 详细的日志功能说明
- [LOGGING_UPDATE_SUMMARY.md](LOGGING_UPDATE_SUMMARY.md) - 更新内容总结
- [README.md](README.md) - 完整的项目文档

## ✨ 功能特点

- ✅ **零配置** - 开箱即用，无需额外配置
- ✅ **可读性强** - 彩色图标、清晰分隔、结构化输出
- ✅ **完整追踪** - 从 HTTP 请求到响应的完整链路
- ✅ **性能监控** - 每个阶段的详细耗时
- ✅ **双重记录** - 控制台 + 文件，满足不同需求
- ✅ **安全可靠** - 过滤敏感信息，自动截断长文本

## 🎉 现在就试试！

```bash
# 启动服务
cd geo_agent
make dev

# 发送请求（在另一个终端）
make test-curl

# 观察控制台的详细日志输出！
```

享受完整的日志可见性！🚀
