# 日志增强说明

## 概述

geo_agent 已增强日志系统，现在会在控制台详细打印所有中转过程中的请求和响应信息，方便开发调试和问题排查。

## 增强内容

### 1. HTTP 请求/响应日志（中间件层）

**位置**: `app/core/middleware.py`

当收到 API 请求时，会打印：
```
🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵
🌐 HTTP请求 - POST /v1/chat/completions
🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵
Request ID: req_xxx
客户端IP: 127.0.0.1
完整URL: http://localhost:8001/v1/chat/completions
请求头:
  content-type: application/json
  ...
🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵🔵
```

响应时打印：
```
🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢
✅ HTTP响应 - 200
🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢
Request ID: req_xxx
状态码: 200
耗时: 1234.56ms
🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢🟢
```

### 2. OpenAI 格式请求解析（API 层）

**位置**: `app/api/v1/chat.py`

接收到 OpenAI 格式请求时打印：
```
================================================================================
📨 收到OpenAI格式请求 - Request ID: req_xxx
================================================================================
客户端IP: 127.0.0.1
模型: qwen-plus
消息数: 2
流式: False
温度: 0.7
最大tokens: 1000

OpenAI消息:
  [1] system: You are a helpful assistant...
  [2] user: What is the weather today?
================================================================================
```

### 3. 中转请求详情（日志服务）

**位置**: `app/core/logger.py`

记录转发到 Qwen API 的请求：
```
================================================================================
📤 中转请求 - Request ID: req_xxx
================================================================================
模型: qwen-plus
消息数: 2
温度: 0.7
最大tokens: 1000

消息内容:
  [1] system: You are a helpful assistant...
  [2] user: What is the weather today?
================================================================================
```

### 4. DashScope API 调用（客户端层）

**位置**: `app/services/qwen_client.py`

调用 DashScope API 时打印：
```
================================================================================
🚀 调用DashScope API
================================================================================
模型: qwen-plus
流式: False
消息数: 2
参数: {
  "temperature": 0.7,
  "max_tokens": 1000,
  "result_format": "message"
}

DashScope消息:
  [1] system: You are a helpful assistant...
  [2] user: What is the weather today?
================================================================================
```

收到 DashScope 响应时打印：
```
================================================================================
✅ DashScope API响应
================================================================================
Request ID: dashscope_req_xxx
响应内容: The weather today is sunny with a temperature of 25°C...
完成原因: stop

Token使用:
  输入tokens: 45
  输出tokens: 123
  总tokens: 168
耗时: 1234.56ms
================================================================================
```

### 5. 中转响应详情（日志服务）

**位置**: `app/core/logger.py`

记录从 Qwen API 收到的响应：
```
================================================================================
📥 中转响应 - Request ID: req_xxx
================================================================================
响应内容: The weather today is sunny with a temperature of 25°C...
完成原因: stop

Token使用:
  输入tokens: 45
  输出tokens: 123
  总tokens: 168
耗时: 1234.56ms
================================================================================
```

### 6. OpenAI 格式响应返回（API 层）

**位置**: `app/api/v1/chat.py`

返回 OpenAI 格式响应时打印：
```
================================================================================
✨ 返回OpenAI格式响应 - Request ID: req_xxx
================================================================================
响应ID: chatcmpl-xxx
模型: qwen-plus
响应内容: The weather today is sunny with a temperature of 25°C...
完成原因: stop

Token使用:
  输入tokens: 45
  输出tokens: 123
  总tokens: 168
总耗时: 1234.56ms
================================================================================
```

### 7. 流式响应（Streaming）

**位置**: `app/api/v1/chat.py`

流式响应完成时打印：
```
================================================================================
✅ 流式响应完成 - Request ID: req_xxx
================================================================================
累计内容长度: 456 字符
内容预览: The weather today is sunny with a temperature of 25°C...
总耗时: 2345.67ms
================================================================================
```

### 8. 错误日志

**位置**: `app/core/logger.py`

当发生错误时打印：
```
================================================================================
❌ API调用错误 - Request ID: req_xxx
================================================================================
错误: Connection timeout
================================================================================
```

## 日志文件

除了控制台打印，所有信息同时记录到以下日志文件：

1. **logs/access.log** - HTTP 访问日志
2. **logs/error.log** - 错误日志
3. **logs/qwen_calls.log** - Qwen API 调用详细日志

所有日志文件使用 JSON 格式，便于后续分析和处理。

## 使用建议

### 开发环境
在开发环境中，这些详细日志非常有用，可以清楚看到：
- 请求转换过程（OpenAI → DashScope）
- API 调用细节
- 响应转换过程（DashScope → OpenAI）
- Token 使用情况
- 性能指标

### 生产环境
在生产环境中，建议：
1. 调整日志级别，减少控制台输出
2. 保留日志文件记录
3. 使用日志分析工具处理 JSON 格式的日志文件

可以通过环境变量 `LOG_LEVEL` 调整日志级别：
```bash
export LOG_LEVEL=WARNING  # 减少控制台输出
```

## 隐私和安全

日志系统已做以下处理：
- 不记录敏感的 HTTP 头（Authorization, Cookie）
- 长文本会自动截断预览（默认 200-500 字符）
- API Key 不会出现在日志中

## 性能影响

打印日志对性能影响极小：
- 控制台打印是异步的
- 文件写入有缓冲机制
- 不影响实际 API 响应时间

## 示例：完整请求流程日志

当收到一个完整的 chat completion 请求时，会按以下顺序打印：

1. 🌐 HTTP 请求（蓝色边框）
2. 📨 收到 OpenAI 格式请求
3. 📤 中转请求
4. 🚀 调用 DashScope API
5. ✅ DashScope API 响应
6. 📥 中转响应
7. ✨ 返回 OpenAI 格式响应
8. ✅ HTTP 响应（绿色边框）

这样可以清晰看到整个请求的完整生命周期！

## 总结

增强后的日志系统提供了：
- ✅ 完整的请求/响应链路追踪
- ✅ 详细的参数和内容展示
- ✅ 性能指标监控
- ✅ 易于阅读的格式化输出
- ✅ 便于分析的 JSON 日志文件
